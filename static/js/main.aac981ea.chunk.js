(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{20:function(e,n,t){},21:function(e,n,t){},30:function(e,n){},31:function(e,n,t){},32:function(e,n,t){"use strict";t.r(n);var r=t(0),c=t(1),a=t.n(c),s=t(12),o=t.n(s),u=(t(20),t(2)),i=(t(21),t(13)),l={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun2.l.google.com:19302"]}]};function f(e){console.log("opened chat!!"),console.log(e.messageHandlers);var n={type:"info",value:"successfully opened connection!!"};for(var t in e.messageHandlers)e.messageHandlers[t](n)}function d(e,n){console.log("received message!"),console.log(e.messageHandlers);var t=JSON.parse(n.data);for(var r in console.log(t),e.messageHandlers)e.messageHandlers[r](t)}function j(e,n){var t=e.messageHandlersIndx;return e.messageHandlers[t]=n,e.messageHandlersIndx="".concat(parseInt(t)+1),t}function b(e,n){e&&(console.log("removing key ".concat(n," from conn ").concat(e)),delete e.messageHandlers[n])}function O(e,n){e.dc.send(JSON.stringify(n))}function g(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function h(e){var n=e;return n.length%4!==0&&(n+="===".slice(0,4-n.length%4)),n=n.replace(/-/g,"+").replace(/_/g,"/"),atob(n)}var p=t(5),m=t.n(p),R=t(10),y=t(4),v=t(14),x=t.n(v);function A(e,n){for(var t,r,c=e.length;0!==c;)r=Math.floor(n()*c),t=e[c-=1],e[c]=e[r],e[r]=t;return e}var S,T=t(8),C="Q",E="K",P=["A","2","3","4","5","6","7","8","9","10","J",C,E],k=["spades","hearts","diamonds","clubs"],_="VOID_CARD";function Y(e){return A(function(){var e,n=[],t=0,r=0,c=Object(T.a)(k);try{for(c.s();!(e=c.n()).done;){var a,s=e.value,o=0,u=Object(T.a)(P);try{for(u.s();!(a=u.n()).done;){var i=a.value;n.push({rank:i,suit:s,rank_index:o,suit_index:t,index:r}),o++,r++}}catch(l){u.e(l)}finally{u.f()}t++}}catch(l){c.e(l)}finally{c.f()}return n}(),e)}function w(e){var n="\ud83c\udca1".charCodeAt(0),t="\ud83c\udca1".charCodeAt(1);return String.fromCharCode(n)+String.fromCharCode(t+e.rank_index+16*e.suit_index+(e.rank===C||e.rank===E?1:0))}function I(e){return e.rank+e.suit.charAt(0).toUpperCase()}function N(e){var n,t="",r=Object(T.a)(e);try{for(r.s();!(n=r.n()).done;){t+=w(n.value)}}catch(c){r.e(c)}finally{r.f()}return t}function L(e,n){return e===_||n===_?e===_&&n===_:e.index===n.index}function D(e,n){e||(console.error("assertion failed"),console.error(n))}var H={SETUP:"SETUP",PLAY:"PLAY",GAMEOVER:"GAMEOVER",ABORT:"ABORT"},M=(Object.values(H),{PRE_READY:"PRE_READY",SENT_READY:"SENT_READY",SENT_START:"SENT_START"}),F=(Object.values(M),{WAIT_FOR_PLAY:"WAIT_FOR_PLAY",WAIT_FOR_PLAYACK:"WAIT_FOR_PLAYACK"}),U=(Object.values(F),{READY:"READY",START:"START",PLAY:"PLAY",PLAYACK:"PLAYACK",ABORT:"ABORT"}),J=Object.values(U),W=(S={},Object(y.a)(S,U.READY,(function(e,n){if(e.phase!==H.SETUP)return Q(e);if(e.state!==M.PRE_READY&&e.state!==M.SENT_READY)return Q(e);var t=n.from,r=n.hash;if(e.players.includes(t))return Q(e);e.players.push(t),e.readyHashes[t]=r,ce(e),K(e)})),Object(y.a)(S,U.START,(function(e,n){return z.apply(this,arguments)})),Object(y.a)(S,U.PLAY,(function(e,n){if(e.phase!==H.PLAY)return Q(e,"wrong phase");if(e.state!==F.WAIT_FOR_PLAY)return Q(e,"wrong state");var t=n.from,r=n.card;if(t!==e.players[e.nextTurn])return Q(e,"user tried to make move but it's not their turn");if(r!==_&&!e.playerHands[t].some((function(e){return L(e,r)})))return Q(e,"user tried to play card not in their hand");if(!Z(e,r))return Q(e,"user tried to play illegal card");X(e,t,r),function(e,n,t){D(e.phase===H.PLAY&&e.state===F.WAIT_FOR_PLAYACK,e),V(e,{method:U.PLAYACK,card:t,user:n}),D(!e.acksReceived.includes(e.userId),e),e.acksReceived.push(e.userId),te(e),K(e)}(e,t,r),K(e)})),Object(y.a)(S,U.PLAYACK,(function(e,n){if(e.phase!==H.PLAY)return Q(e,"wrong phase");if(e.state!==F.WAIT_FOR_PLAYACK)return Q(e,"wrong state");var t=n.user,r=n.from,c=n.card;if(t!==e.lastPlayedUser)return Q(e,"tried to ack the wrong user");if(!L(c,e.lastPlayedCard))return Q(e,"tried to ack the wrong card");if(e.acksReceived.includes(r))return Q(e,"already received ack from this user");e.acksReceived.push(r),te(e),K(e)})),Object(y.a)(S,U.ABORT,(function(e,n){console.log("ABORTING :(((( SAD"),D(!1,"not implemented yet!!"),K(e)})),S);function B(e,n){var t=e.listenerIndex;return e.listeners[t]=n,e.listenerIndex="".concat(parseInt(t)+1),t}function G(e,n){e&&(console.log("removing key ".concat(n," from game ").concat(e)),console.log(e),delete e.listeners[n])}function K(e){for(var n=0,t=Object.values(e.listeners);n<t.length;n++){(0,t[n])()}}function V(e,n){var t,r;n.from=e.userId,t=e.conn,r=n,O(t,Object(i.a)({type:"data"},r))}function z(){return(z=Object(R.a)(m.a.mark((function e(n,t){var r,c,a;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.phase===H.SETUP){e.next=2;break}return e.abrupt("return",Q(n,"wrong phase"));case 2:if(n.state===M.SENT_READY||n.state===M.SENT_START){e.next=4;break}return e.abrupt("return",Q(n));case 4:if(r=t.from,c=t.randomNumber,!Object.keys(n.startNumbers).includes(r)){e.next=8;break}return e.abrupt("return",Q(n));case 8:if(n.players.includes(r)){e.next=10;break}return e.abrupt("return",Q(n,"unknown user ".concat(r)));case 10:return e.next=12,$("".concat(c));case 12:if(a=e.sent,n.readyHashes[r]===a){e.next=15;break}return e.abrupt("return",Q(n,"incorrect hash ".concat(a," received for random number ").concat(c," from user ").concat(r)));case 15:n.startNumbers[r]=c,re(n),K(n);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Q(e,n){console.error("ABORT GAME :(("),console.error(n),V(e,{method:U.ABORT,reason:n}),e.phase=H.ABORT,K(e)}function $(e){return q.apply(this,arguments)}function q(){return(q=Object(R.a)(m.a.mark((function e(n){var t,r,c,a,s;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new TextEncoder,r=t.encode(n),e.next=4,crypto.subtle.digest("SHA-256",r);case 4:return c=e.sent,a=Array.from(new Uint8Array(c)),s=a.map((function(e){return e.toString(16).padStart(2,"0")})).join(""),e.abrupt("return",s);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function X(e,n,t){e.nextTurn=(e.nextTurn+1)%e.players.length,e.state=F.WAIT_FOR_PLAYACK,e.lastPlayedCard=t,e.lastPlayedUser=n,t!==_&&(e.playedCards.push(t),e.playerHands[n]=e.playerHands[n].filter((function(e){return e.index!==t.index}))),K(e)}function Z(e,n){if(n===_)return!0;if(0===e.playedCards.length)return!0;var t=e.playedCards[e.playedCards.length-1];return t.suit===n.suit||t.rank===n.rank}function ee(e,n){D(e.phase===H.PLAY&&ie(e),e),D(e.state===F.WAIT_FOR_PLAY,e),D(n===_||e.playerHands[e.userId].some((function(e){return L(e,n)})),e),console.log("play card!"),console.log(n),D(Z(e,n),e),V(e,{method:U.PLAY,card:n}),X(e,e.userId,n),K(e)}function ne(){return(ne=Object(R.a)(m.a.mark((function e(n){var t;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D(n.phase===H.SETUP&&n.state===M.PRE_READY||n.phase===H.GAMEOVER,n),n.myRandom=Math.floor(Math.random()*Math.pow(2,64)),e.next=4,$("".concat(n.myRandom));case 4:t=e.sent,console.log(t),n.readyHashes[n.userId]=t,V(n,{method:U.READY,hash:t}),n.state=M.SENT_READY,ce(n),K(n);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function te(e){e.acksReceived.length===e.players.length-1&&(e.state=F.WAIT_FOR_PLAY,e.acksReceived=[],e.lastPlayedCard=null,e.lastPlayedUser=null,K(e))}function re(e){e.players.length===Object.keys(e.startNumbers).length&&function(e){D(e.phase===H.SETUP&&e.state===M.SENT_START,e);var n=0;Object.values(e.startNumbers).forEach((function(e){n^=e})),console.log("final randomness: ".concat(n));var t=x()("".concat(n));delete e.state,delete e.readyHashes,delete e.startNumbers,delete e.myRandom,e.players=A(e.players.sort(),t),e.nextTurn=0,e.playedCards=[],e.playerHands=function(e,n){var t,r=Y(n),c={},a=0,s=Object(T.a)(e);try{for(s.s();!(t=s.n()).done;)c[t.value]=[]}catch(i){s.e(i)}finally{s.f()}for(;a<r.length;){var o,u=Object(T.a)(e);try{for(u.s();!(o=u.n()).done;)c[o.value].push(r[a]),a++}catch(i){u.e(i)}finally{u.f()}}return c}(A(e.players,t),t),e.state=F.WAIT_FOR_PLAY,e.acksReceived=[],e.lastPlayedCard=null,e.lastPlayedUser=null,e.phase=H.PLAY,console.log("STARTING GAME!!!! exciting :)))"),console.log(e),K(e)}(e)}function ce(e){e.conn,1===Object.keys(e.readyHashes).length-1&&(D(e.players.length===Object.keys(e.readyHashes).length,e),function(e){D(e.phase===H.SETUP&&e.state===M.SENT_READY,e),V(e,{method:U.START,randomNumber:e.myRandom}),e.startNumbers[e.userId]=e.myRandom,e.state=M.SENT_START,re(e),K(e)}(e))}function ae(e){return e.userId}function se(e){return e.players.filter((function(n){return n!==ae(e)}))[0]}function oe(e){return e.playerHands[ae(e)]}function ue(e){return e.playerHands[se(e)]}function ie(e){return ae(e)===e.players[e.nextTurn]}function le(e){return ie(e)&&e.state===F.WAIT_FOR_PLAY}D(JSON.stringify(J)===JSON.stringify(Object.keys(W)),{methods:J,handlers:W});t(31);function fe(e){var n=Object(c.useState)(""),t=Object(u.a)(n,2),a=t[0],s=t[1],o=Object(c.useState)(""),i=Object(u.a)(o,2),l=i[0],f=i[1];function d(){O(e.connRef.current,{type:"message",message:a}),g(a),s("")}function g(e){f((function(n){return""===n?e:e+"\n"+n}))}return Object(c.useEffect)((function(){var n=j(e.connRef.current,(function(e){if("message"===e.type)return g(e.message);g(JSON.stringify(e))}));return function(){console.log("cleaning up chat!!! index ".concat(n)),b(e.connRef.current,n)}}),[e.connRef]),Object(r.jsxs)("div",{children:[Object(r.jsx)("input",{type:"text",value:a,onChange:function(e){return s(e.target.value)},onKeyUp:function(e){return"Enter"===e.key?d():0}}),Object(r.jsx)("button",{onClick:d,children:"Send message"}),Object(r.jsx)("p",{style:{whiteSpace:"pre-line"},children:l})]})}function de(){return Object(r.jsx)("div",{children:"Waiting for everyone else to press start..."})}function je(e){var n=Object(c.useState)(e.gameRef.current.playedCards),t=Object(u.a)(n,2),a=t[0],s=t[1],o=Object(c.useState)(oe(e.gameRef.current)),i=Object(u.a)(o,2),l=i[0],f=i[1],d=Object(c.useState)(ue(e.gameRef.current)),j=Object(u.a)(d,2),b=j[0],O=j[1],g=Object(c.useState)(ae(e.gameRef.current)),h=Object(u.a)(g,2),p=h[0],m=h[1],R=Object(c.useState)(se(e.gameRef.current)),y=Object(u.a)(R,2),v=y[0],x=y[1],A=Object(c.useState)(null),S=Object(u.a)(A,2),T=S[0],C=S[1],E=Object(c.useState)(le(e.gameRef.current)),Y=Object(u.a)(E,2),w=Y[0],I=Y[1],N=Object(c.useCallback)((function(e){C(e.currentTarget.value)}),[]),L=Object(c.useCallback)((function(){s(e.gameRef.current.playedCards),f(oe(e.gameRef.current)),O(ue(e.gameRef.current)),m(ae(e.gameRef.current)),x(se(e.gameRef.current)),I(le(e.gameRef.current))}),[e.gameRef]);return Object(c.useEffect)((function(){var n=B(e.gameRef.current,L);return function(){G(e.gameRef.current,n)}}),[e.gameRef,L]),Object(r.jsxs)("div",{children:["Playing the game!!!",Object(r.jsx)("hr",{}),Object(r.jsx)(ge,{cards:b,user:v}),Object(r.jsx)(Oe,{cards:a}),Object(r.jsx)(he,{cards:l,user:p,changeCard:N,selectedCard:T}),Object(r.jsx)(be,{myTurn:w,play:function(){return ee(e.gameRef.current,function(e){var n="\ud83c\udca1".charCodeAt(1),t=e.charCodeAt(1)-n,r=Math.floor(t/16),c=t%16;return c>=12&&c--,{suit:k[r],rank:P[c],suit_index:r,rank_index:c,index:13*r+c}}(T))},pass:function(){return ee(e.gameRef.current,_)}})]})}function be(e){return Object(r.jsxs)("div",{children:[Object(r.jsx)("button",{onClick:e.play,disabled:!e.myTurn,children:"Play!"}),Object(r.jsx)("button",{onClick:e.pass,disabled:!e.myTurn,children:"Pass"})]})}function Oe(e){return Object(r.jsxs)("div",{children:["played cards: ",Object(r.jsx)(pe,{cards:e.cards})]})}function ge(e){return Object(r.jsxs)("div",{children:[e.user,"'s cards:",Object(r.jsx)(pe,{cards:e.cards})]})}function he(e){return Object(r.jsxs)("div",{children:["my cards:",Object(r.jsx)(me,{cards:e.cards,changeCard:e.changeCard,selectedCard:e.selectedCard})]})}function pe(e){return 0===e.cards.length?Object(r.jsx)("div",{children:"(none)"}):Object(r.jsx)("div",{style:{fontSize:"3em"},children:N(e.cards)})}function me(e){return 0===e.cards.length?Object(r.jsx)("div",{children:"(none)"}):Object(r.jsx)("div",{style:{fontSize:"3em"},className:"SelectableDeck",children:e.cards.map((function(n,t){return Object(r.jsxs)(a.a.Fragment,{children:[Object(r.jsx)("input",{type:"radio",name:"mycards",value:w(n),checked:e.selectedCard===w(n),onChange:e.changeCard,id:I(n)},"mycardsradio".concat(t)),Object(r.jsx)("label",{htmlFor:I(n),children:w(n)},"mycardslabel".concat(t))]},"mycardsfragment".concat(t))}))})}function Re(e){var n=Object(c.useState)(e.gameRef.current.phase),t=Object(u.a)(n,2),a=t[0],s=t[1],o=Object(c.useState)(ae(e.gameRef.current)),i=Object(u.a)(o,2),l=i[0],f=i[1],d=Object(c.useCallback)((function(){s(e.gameRef.current.phase),f(ae(e.gameRef.current))}),[e.gameRef]);return Object(c.useEffect)((function(){var n=B(e.gameRef.current,d);return function(){G(e.gameRef.current,n)}}),[e.gameRef,d]),Object(r.jsxs)("div",{children:["welcome to the game, ",l,"!",Object(r.jsx)("hr",{}),a===H.SETUP&&Object(r.jsx)(de,{}),a===H.PLAY&&Object(r.jsx)(je,{gameRef:e.gameRef}),Object(r.jsx)("hr",{}),Object(r.jsx)(fe,{connRef:e.connRef})]})}function ye(e){return Object(r.jsx)("div",{children:Object(r.jsx)("button",{onClick:function(){return n=e.connRef.current,t=e.setMyOffer,console.log("create offer"),console.log(n.pc.signalingState),n.dc=n.pc.createDataChannel("chat"),n.dc.onopen=function(){return f(n)},n.dc.onmessage=function(e){return d(n,e)},n.pc.createOffer().then((function(e){return n.pc.setLocalDescription(e)})).catch(console.log),void(n.pc.onicecandidate=function(e){e.candidate||t(g(JSON.stringify(n.pc.localDescription)))});var n,t},children:"Create game"})})}function ve(e){var n=Object(c.useState)(""),t=Object(u.a)(n,2),a=t[0],s=t[1];return Object(r.jsxs)("div",{children:["send this message to your friends: ",Object(r.jsx)("code",{children:e.offer}),Object(r.jsx)("br",{}),"input their answer:",Object(r.jsx)("input",{type:"text",value:a,onChange:function(e){return s(e.target.value)}}),Object(r.jsx)("button",{onClick:function(){return function(e,n){console.log("join"),console.log(e.pc.signalingState);var t=new RTCSessionDescription(JSON.parse(h(n)));e.pc.setRemoteDescription(t).catch(console.log)}(e.connRef.current,a)},children:"Add player"})]})}function xe(e){var n=Object(c.useState)(""),t=Object(u.a)(n,2),a=t[0],s=t[1];return Object(r.jsxs)("div",{children:[Object(r.jsx)("input",{type:"text",value:a,onChange:function(e){return s(e.target.value)}}),Object(r.jsx)("button",{onClick:function(){return function(e,n,t){console.log("join"),console.log(e.pc.signalingState);var r=new RTCSessionDescription(JSON.parse(h(n)));e.pc.setRemoteDescription(r).then((function(){return e.pc.createAnswer()})).then((function(n){return e.pc.setLocalDescription(n)})).catch(console.log),e.pc.onicecandidate=function(n){n.candidate||t(g(JSON.stringify(e.pc.localDescription)))}}(e.connRef.current,a,e.setMyAnswer)},children:"Join"})]})}function Ae(e){return Object(r.jsxs)("div",{children:["send this message to your friends: ",Object(r.jsx)("code",{children:e.answer}),Object(r.jsx)("br",{})]})}function Se(e){return console.log(e.connRef),Object(r.jsxs)("div",{children:[Object(r.jsx)(ye,{connRef:e.connRef,setMyOffer:e.setMyOffer}),Object(r.jsx)("br",{}),Object(r.jsx)(xe,{connRef:e.connRef,setMyAnswer:e.setMyAnswer}),Object(r.jsx)("br",{})]})}function Te(e){return Object(r.jsxs)("div",{children:[e.offer?Object(r.jsx)(ve,{connRef:e.connRef,offer:e.offer}):Object(r.jsx)(Ae,{connRef:e.connRef,answer:e.answer}),Object(r.jsx)("hr",{}),"Participants list: idk",Object(r.jsx)("br",{}),Object(r.jsx)("hr",{}),Object(r.jsx)("button",{onClick:e.startGame,children:"Start game!"}),Object(r.jsx)("hr",{}),Object(r.jsx)(fe,{connRef:e.connRef})]})}function Ce(e){var n=Object(c.useState)(null),t=Object(u.a)(n,2),s=t[0],o=t[1],i=Object(c.useState)(null),l=Object(u.a)(i,2),f=l[0],d=l[1];return s||f?Object(r.jsx)(Te,{connRef:e.connRef,offer:s,answer:f,startGame:e.startGame}):Object(r.jsx)(a.a.Fragment,{children:Object(r.jsx)(Se,{connRef:e.connRef,setMyOffer:o,setMyAnswer:d})})}var Ee=function(){var e=Object(c.useState)(!0),n=Object(u.a)(e,2),t=n[0],a=n[1],s=Object(c.useRef)(),o=Object(c.useRef)(),i=Object(c.useCallback)((function(){a(!1),function(e){ne.apply(this,arguments)}(o.current)}),[o]);return Object(c.useEffect)((function(){s.current=function(){var e={pc:new RTCPeerConnection(l),dc:null,messageHandlers:{},messageHandlersIndx:"0"};return e.pc.ondatachannel=function(n){e.dc=n.channel,e.dc.onopen=function(){return f(e)},e.dc.onmessage=function(n){return d(e,n)}},e.pc.oniceconnectionstatechange=function(n){return console.log(e.pc.iceConnectionState)},e}(),o.current=function(e){var n=Math.random().toString(36).substr(2,9);return{conn:e,listeners:{},listenerIndex:"0",phase:H.SETUP,userId:n,state:M.PRE_READY,players:[n],readyHashes:{},startNumbers:{},myRandom:null}}(s.current)}),[]),Object(c.useEffect)((function(){var e=j(s.current,(function(e){return function(e,n){console.log("game receiving message!"),console.log(n),"data"===n.type?(D(J.includes(n.method)),console.log(W),W[n.method](e,n)):console.log("ignoring non-data message")}(o.current,e)}));return function(){b(s.current,e)}}),[s,o]),Object(r.jsxs)("div",{className:"App",children:[t&&Object(r.jsx)(Ce,{connRef:s,startGame:i}),!t&&Object(r.jsx)(Re,{connRef:s,gameRef:o})]})},Pe=function(e){e&&e instanceof Function&&t.e(3).then(t.bind(null,33)).then((function(n){var t=n.getCLS,r=n.getFID,c=n.getFCP,a=n.getLCP,s=n.getTTFB;t(e),r(e),c(e),a(e),s(e)}))};o.a.render(Object(r.jsx)(a.a.StrictMode,{children:Object(r.jsx)(Ee,{})}),document.getElementById("root")),Pe()}},[[32,1,2]]]);
//# sourceMappingURL=main.aac981ea.chunk.js.map