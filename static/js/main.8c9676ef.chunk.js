(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{20:function(e,n,t){},21:function(e,n,t){},30:function(e,n){},31:function(e,n,t){},32:function(e,n,t){"use strict";t.r(n);var r=t(0),c=t(1),a=t.n(c),s=t(12),o=t.n(s),u=(t(20),t(2)),i=(t(21),t(13)),l={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun2.l.google.com:19302"]}]};function d(e){console.log("opened chat!!"),console.log(e.messageHandlers);var n={type:"info",value:"successfully opened connection!!"};for(var t in e.messageHandlers)e.messageHandlers[t](n)}function f(e,n){console.log("received message!"),console.log(e.messageHandlers);var t=JSON.parse(n.data);for(var r in console.log(t),e.messageHandlers)e.messageHandlers[r](t)}function j(e,n){var t=e.messageHandlersIndx;return e.messageHandlers[t]=n,e.messageHandlersIndx="".concat(parseInt(t)+1),t}function b(e,n){e&&(console.log("removing key ".concat(n," from conn ").concat(e)),delete e.messageHandlers[n])}function O(e,n){e.dc.send(JSON.stringify(n))}function g(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function h(e){var n=e;return n.length%4!==0&&(n+="===".slice(0,4-n.length%4)),n=n.replace(/-/g,"+").replace(/_/g,"/"),atob(n)}var p=t(5),m=t.n(p),R=t(10),y=t(4),x=t(14),v=t.n(x);function A(e,n){for(var t,r,c=e.length;0!==c;)r=Math.floor(n()*c),t=e[c-=1],e[c]=e[r],e[r]=t;return e}var S,T=t(8),C="Q",E="K",P=["A","2","3","4","5","6","7","8","9","10","J",C,E],k=["spades","hearts","diamonds","clubs"];function _(e){return A(function(){var e,n=[],t=0,r=0,c=Object(T.a)(k);try{for(c.s();!(e=c.n()).done;){var a,s=e.value,o=0,u=Object(T.a)(P);try{for(u.s();!(a=u.n()).done;){var i=a.value;n.push({rank:i,suit:s,rank_index:o,suit_index:t,index:r}),o++,r++}}catch(l){u.e(l)}finally{u.f()}t++}}catch(l){c.e(l)}finally{c.f()}return n}(),e)}function Y(e){var n="\ud83c\udca1".charCodeAt(0),t="\ud83c\udca1".charCodeAt(1);return String.fromCharCode(n)+String.fromCharCode(t+e.rank_index+16*e.suit_index+(e.rank===C||e.rank===E?1:0))}function w(e){return e.rank+e.suit.charAt(0).toUpperCase()}function I(e){var n,t="",r=Object(T.a)(e);try{for(r.s();!(n=r.n()).done;){t+=Y(n.value)}}catch(c){r.e(c)}finally{r.f()}return t}function N(e,n){e||(console.error("assertion failed"),console.error(n))}var L={SETUP:"SETUP",PLAY:"PLAY",GAMEOVER:"GAMEOVER",ABORT:"ABORT"},D=(Object.values(L),{PRE_READY:"PRE_READY",SENT_READY:"SENT_READY",SENT_START:"SENT_START"}),H=(Object.values(D),{WAIT_FOR_PLAY:"WAIT_FOR_PLAY",WAIT_FOR_PLAYACK:"WAIT_FOR_PLAYACK"}),M=(Object.values(H),{READY:"READY",START:"START",PLAY:"PLAY",PLAYACK:"PLAYACK",ABORT:"ABORT"}),F=Object.values(M),U=(S={},Object(y.a)(S,M.READY,(function(e,n){if(e.phase!==L.SETUP)return V(e);if(e.state!==D.PRE_READY&&e.state!==D.SENT_READY)return V(e);var t=n.from,r=n.hash;if(e.players.includes(t))return V(e);e.players.push(t),e.readyHashes[t]=r,ne(e),B(e)})),Object(y.a)(S,M.START,(function(e,n){return K.apply(this,arguments)})),Object(y.a)(S,M.PLAY,(function(e,n){if(e.phase!==L.PLAY)return V(e,"wrong phase");if(e.state!==H.WAIT_FOR_PLAY)return V(e,"wrong state");var t=n.from,r=n.card;if(t!==e.players[e.nextTurn])return V(e,"user tried to make move but it's not their turn");if(!e.playerHands[t].some((function(e){return e.index===r.index})))return V(e,"user tried to play card not in their hand");if(!q(e,r))return V(e,"user tried to play illegal card");$(e,t,r),function(e,n,t){N(e.phase===L.PLAY&&e.state===H.WAIT_FOR_PLAYACK,e),G(e,{method:M.PLAYACK,card:t,user:n}),N(!e.acksReceived.includes(e.userId),e),e.acksReceived.push(e.userId),Z(e),B(e)}(e,t,r),B(e)})),Object(y.a)(S,M.PLAYACK,(function(e,n){if(e.phase!==L.PLAY)return V(e,"wrong phase");if(e.state!==H.WAIT_FOR_PLAYACK)return V(e,"wrong state");var t=n.user,r=n.from,c=n.card;if(t!==e.lastPlayedUser)return V(e,"tried to ack the wrong user");if(c.index!==e.lastPlayedCard.index)return V(e,"tried to ack the wrong card");if(e.acksReceived.includes(r))return V(e,"already received ack from this user");e.acksReceived.push(r),Z(e),B(e)})),Object(y.a)(S,M.ABORT,(function(e,n){console.log("ABORTING :(((( SAD"),N(!1,"not implemented yet!!"),B(e)})),S);function J(e,n){var t=e.listenerIndex;return e.listeners[t]=n,e.listenerIndex="".concat(parseInt(t)+1),t}function W(e,n){e&&(console.log("removing key ".concat(n," from game ").concat(e)),console.log(e),delete e.listeners[n])}function B(e){for(var n=0,t=Object.values(e.listeners);n<t.length;n++){(0,t[n])()}}function G(e,n){var t,r;n.from=e.userId,t=e.conn,r=n,O(t,Object(i.a)({type:"data"},r))}function K(){return(K=Object(R.a)(m.a.mark((function e(n,t){var r,c,a;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.phase===L.SETUP){e.next=2;break}return e.abrupt("return",V(n,"wrong phase"));case 2:if(n.state===D.SENT_READY||n.state===D.SENT_START){e.next=4;break}return e.abrupt("return",V(n));case 4:if(r=t.from,c=t.randomNumber,!Object.keys(n.startNumbers).includes(r)){e.next=8;break}return e.abrupt("return",V(n));case 8:if(n.players.includes(r)){e.next=10;break}return e.abrupt("return",V(n,"unknown user ".concat(r)));case 10:return e.next=12,z("".concat(c));case 12:if(a=e.sent,n.readyHashes[r]===a){e.next=15;break}return e.abrupt("return",V(n,"incorrect hash ".concat(a," received for random number ").concat(c," from user ").concat(r)));case 15:n.startNumbers[r]=c,ee(n),B(n);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function V(e,n){console.error("ABORT GAME :(("),console.error(n),G(e,{method:M.ABORT,reason:n}),e.phase=L.ABORT,B(e)}function z(e){return Q.apply(this,arguments)}function Q(){return(Q=Object(R.a)(m.a.mark((function e(n){var t,r,c,a,s;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new TextEncoder,r=t.encode(n),e.next=4,crypto.subtle.digest("SHA-256",r);case 4:return c=e.sent,a=Array.from(new Uint8Array(c)),s=a.map((function(e){return e.toString(16).padStart(2,"0")})).join(""),e.abrupt("return",s);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function $(e,n,t){e.playedCards.push(t),e.playerHands[n]=e.playerHands[n].filter((function(e){return e.index!==t.index})),e.nextTurn=(e.nextTurn+1)%e.players.length,e.state=H.WAIT_FOR_PLAYACK,e.lastPlayedCard=t,e.lastPlayedUser=n,B(e)}function q(e,n){if(0===e.playedCards.length)return!0;var t=e.playedCards[e.playedCards.length-1];return t.suit===n.suit||t.rank===n.rank}function X(){return(X=Object(R.a)(m.a.mark((function e(n){var t;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return N(n.phase===L.SETUP&&n.state===D.PRE_READY||n.phase===L.GAMEOVER,n),n.myRandom=Math.floor(Math.random()*Math.pow(2,64)),e.next=4,z("".concat(n.myRandom));case 4:t=e.sent,console.log(t),n.readyHashes[n.userId]=t,G(n,{method:M.READY,hash:t}),n.state=D.SENT_READY,ne(n),B(n);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Z(e){e.acksReceived.length===e.players.length-1&&(e.state=H.WAIT_FOR_PLAY,e.acksReceived=[],e.lastPlayedCard=null,e.lastPlayedUser=null,B(e))}function ee(e){e.players.length===Object.keys(e.startNumbers).length&&function(e){N(e.phase===L.SETUP&&e.state===D.SENT_START,e);var n=0;Object.values(e.startNumbers).forEach((function(e){n^=e})),console.log("final randomness: ".concat(n));var t=v()("".concat(n));delete e.state,delete e.readyHashes,delete e.startNumbers,delete e.myRandom,e.players=A(e.players.sort(),t),e.nextTurn=0,e.playedCards=[],e.playerHands=function(e,n){var t,r=_(n),c={},a=0,s=Object(T.a)(e);try{for(s.s();!(t=s.n()).done;)c[t.value]=[]}catch(i){s.e(i)}finally{s.f()}for(;a<r.length;){var o,u=Object(T.a)(e);try{for(u.s();!(o=u.n()).done;)c[o.value].push(r[a]),a++}catch(i){u.e(i)}finally{u.f()}}return c}(A(e.players,t),t),e.state=H.WAIT_FOR_PLAY,e.acksReceived=[],e.lastPlayedCard=null,e.lastPlayedUser=null,e.phase=L.PLAY,console.log("STARTING GAME!!!! exciting :)))"),console.log(e),B(e)}(e)}function ne(e){e.conn,1===Object.keys(e.readyHashes).length-1&&(N(e.players.length===Object.keys(e.readyHashes).length,e),function(e){N(e.phase===L.SETUP&&e.state===D.SENT_READY,e),G(e,{method:M.START,randomNumber:e.myRandom}),e.startNumbers[e.userId]=e.myRandom,e.state=D.SENT_START,ee(e),B(e)}(e))}function te(e){return e.userId}function re(e){return e.players.filter((function(n){return n!==te(e)}))[0]}function ce(e){return e.playerHands[te(e)]}function ae(e){return e.playerHands[re(e)]}function se(e){return te(e)===e.players[e.nextTurn]}function oe(e){return se(e)&&e.state===H.WAIT_FOR_PLAY}N(JSON.stringify(F)===JSON.stringify(Object.keys(U)),{methods:F,handlers:U});t(31);function ue(e){var n=Object(c.useState)(""),t=Object(u.a)(n,2),a=t[0],s=t[1],o=Object(c.useState)(""),i=Object(u.a)(o,2),l=i[0],d=i[1];function f(){O(e.connRef.current,{type:"message",message:a}),g(a),s("")}function g(e){d((function(n){return""===n?e:e+"\n"+n}))}return Object(c.useEffect)((function(){var n=j(e.connRef.current,(function(e){if("message"===e.type)return g(e.message);g(JSON.stringify(e))}));return function(){console.log("cleaning up chat!!! index ".concat(n)),b(e.connRef.current,n)}}),[e.connRef]),Object(r.jsxs)("div",{children:[Object(r.jsx)("input",{type:"text",value:a,onChange:function(e){return s(e.target.value)},onKeyUp:function(e){return"Enter"===e.key?f():0}}),Object(r.jsx)("button",{onClick:f,children:"Send message"}),Object(r.jsx)("p",{style:{whiteSpace:"pre-line"},children:l})]})}function ie(){return Object(r.jsx)("div",{children:"Waiting for everyone else to press start..."})}function le(e){var n=Object(c.useState)(e.gameRef.current.playedCards),t=Object(u.a)(n,2),a=t[0],s=t[1],o=Object(c.useState)(ce(e.gameRef.current)),i=Object(u.a)(o,2),l=i[0],d=i[1],f=Object(c.useState)(ae(e.gameRef.current)),j=Object(u.a)(f,2),b=j[0],O=j[1],g=Object(c.useState)(te(e.gameRef.current)),h=Object(u.a)(g,2),p=h[0],m=h[1],R=Object(c.useState)(re(e.gameRef.current)),y=Object(u.a)(R,2),x=y[0],v=y[1],A=Object(c.useState)(null),S=Object(u.a)(A,2),T=S[0],C=S[1],E=Object(c.useState)(oe(e.gameRef.current)),_=Object(u.a)(E,2),Y=_[0],w=_[1],I=Object(c.useCallback)((function(e){C(e.currentTarget.value)}),[]),D=Object(c.useCallback)((function(){s(e.gameRef.current.playedCards),d(ce(e.gameRef.current)),O(ae(e.gameRef.current)),m(te(e.gameRef.current)),v(re(e.gameRef.current)),w(oe(e.gameRef.current))}),[e.gameRef]);return Object(c.useEffect)((function(){var n=J(e.gameRef.current,D);return function(){W(e.gameRef.current,n)}}),[e.gameRef,D]),Object(r.jsxs)("div",{children:["Playing the game!!!",Object(r.jsx)("hr",{}),Object(r.jsx)(je,{cards:b,user:x}),Object(r.jsx)(fe,{cards:a}),Object(r.jsx)(be,{cards:l,user:p,changeCard:I,selectedCard:T}),Object(r.jsx)(de,{myTurn:Y,play:function(){return n=e.gameRef.current,t=function(e){var n="\ud83c\udca1".charCodeAt(1),t=e.charCodeAt(1)-n,r=Math.floor(t/16),c=t%16;return c>=12&&c--,{suit:k[r],rank:P[c],suit_index:r,rank_index:c,index:13*r+c}}(T),N(n.phase===L.PLAY&&se(n),n),N(n.state===H.WAIT_FOR_PLAY,n),N(n.playerHands[n.userId].some((function(e){return e.index===t.index})),n),console.log("play card!"),console.log(t),N(q(n,t),n),G(n,{method:M.PLAY,card:t}),$(n,n.userId,t),void B(n);var n,t}})]})}function de(e){return Object(r.jsx)("div",{children:Object(r.jsx)("button",{onClick:e.play,disabled:!e.myTurn,children:"Play!"})})}function fe(e){return Object(r.jsxs)("div",{children:["played cards: ",Object(r.jsx)(Oe,{cards:e.cards})]})}function je(e){return Object(r.jsxs)("div",{children:[e.user,"'s cards:",Object(r.jsx)(Oe,{cards:e.cards})]})}function be(e){return Object(r.jsxs)("div",{children:["my cards:",Object(r.jsx)(ge,{cards:e.cards,changeCard:e.changeCard,selectedCard:e.selectedCard})]})}function Oe(e){return 0===e.cards.length?Object(r.jsx)("div",{children:"(none)"}):Object(r.jsx)("div",{style:{fontSize:"3em"},children:I(e.cards)})}function ge(e){return 0===e.cards.length?Object(r.jsx)("div",{children:"(none)"}):Object(r.jsx)("div",{style:{fontSize:"3em"},className:"SelectableDeck",children:e.cards.map((function(n,t){return Object(r.jsxs)(a.a.Fragment,{children:[Object(r.jsx)("input",{type:"radio",name:"mycards",value:Y(n),checked:e.selectedCard===Y(n),onChange:e.changeCard,id:w(n)},"mycardsradio".concat(t)),Object(r.jsx)("label",{htmlFor:w(n),children:Y(n)},"mycardslabel".concat(t))]},"mycardsfragment".concat(t))}))})}function he(e){var n=Object(c.useState)(e.gameRef.current.phase),t=Object(u.a)(n,2),a=t[0],s=t[1],o=Object(c.useState)(te(e.gameRef.current)),i=Object(u.a)(o,2),l=i[0],d=i[1],f=Object(c.useCallback)((function(){s(e.gameRef.current.phase),d(te(e.gameRef.current))}),[e.gameRef]);return Object(c.useEffect)((function(){var n=J(e.gameRef.current,f);return function(){W(e.gameRef.current,n)}}),[e.gameRef,f]),Object(r.jsxs)("div",{children:["welcome to the game, ",l,"!",Object(r.jsx)("hr",{}),a===L.SETUP&&Object(r.jsx)(ie,{}),a===L.PLAY&&Object(r.jsx)(le,{gameRef:e.gameRef}),Object(r.jsx)("hr",{}),Object(r.jsx)(ue,{connRef:e.connRef})]})}function pe(e){return Object(r.jsx)("div",{children:Object(r.jsx)("button",{onClick:function(){return n=e.connRef.current,t=e.setMyOffer,console.log("create offer"),console.log(n.pc.signalingState),n.dc=n.pc.createDataChannel("chat"),n.dc.onopen=function(){return d(n)},n.dc.onmessage=function(e){return f(n,e)},n.pc.createOffer().then((function(e){return n.pc.setLocalDescription(e)})).catch(console.log),void(n.pc.onicecandidate=function(e){e.candidate||t(g(JSON.stringify(n.pc.localDescription)))});var n,t},children:"Create game"})})}function me(e){var n=Object(c.useState)(""),t=Object(u.a)(n,2),a=t[0],s=t[1];return Object(r.jsxs)("div",{children:["send this message to your friends: ",Object(r.jsx)("code",{children:e.offer}),Object(r.jsx)("br",{}),"input their answer:",Object(r.jsx)("input",{type:"text",value:a,onChange:function(e){return s(e.target.value)}}),Object(r.jsx)("button",{onClick:function(){return function(e,n){console.log("join"),console.log(e.pc.signalingState);var t=new RTCSessionDescription(JSON.parse(h(n)));e.pc.setRemoteDescription(t).catch(console.log)}(e.connRef.current,a)},children:"Add player"})]})}function Re(e){var n=Object(c.useState)(""),t=Object(u.a)(n,2),a=t[0],s=t[1];return Object(r.jsxs)("div",{children:[Object(r.jsx)("input",{type:"text",value:a,onChange:function(e){return s(e.target.value)}}),Object(r.jsx)("button",{onClick:function(){return function(e,n,t){console.log("join"),console.log(e.pc.signalingState);var r=new RTCSessionDescription(JSON.parse(h(n)));e.pc.setRemoteDescription(r).then((function(){return e.pc.createAnswer()})).then((function(n){return e.pc.setLocalDescription(n)})).catch(console.log),e.pc.onicecandidate=function(n){n.candidate||t(g(JSON.stringify(e.pc.localDescription)))}}(e.connRef.current,a,e.setMyAnswer)},children:"Join"})]})}function ye(e){return Object(r.jsxs)("div",{children:["send this message to your friends: ",Object(r.jsx)("code",{children:e.answer}),Object(r.jsx)("br",{})]})}function xe(e){return console.log(e.connRef),Object(r.jsxs)("div",{children:[Object(r.jsx)(pe,{connRef:e.connRef,setMyOffer:e.setMyOffer}),Object(r.jsx)("br",{}),Object(r.jsx)(Re,{connRef:e.connRef,setMyAnswer:e.setMyAnswer}),Object(r.jsx)("br",{})]})}function ve(e){return Object(r.jsxs)("div",{children:[e.offer?Object(r.jsx)(me,{connRef:e.connRef,offer:e.offer}):Object(r.jsx)(ye,{connRef:e.connRef,answer:e.answer}),Object(r.jsx)("hr",{}),"Participants list: idk",Object(r.jsx)("br",{}),Object(r.jsx)("hr",{}),Object(r.jsx)("button",{onClick:e.startGame,children:"Start game!"}),Object(r.jsx)("hr",{}),Object(r.jsx)(ue,{connRef:e.connRef})]})}function Ae(e){var n=Object(c.useState)(null),t=Object(u.a)(n,2),s=t[0],o=t[1],i=Object(c.useState)(null),l=Object(u.a)(i,2),d=l[0],f=l[1];return s||d?Object(r.jsx)(ve,{connRef:e.connRef,offer:s,answer:d,startGame:e.startGame}):Object(r.jsx)(a.a.Fragment,{children:Object(r.jsx)(xe,{connRef:e.connRef,setMyOffer:o,setMyAnswer:f})})}var Se=function(){var e=Object(c.useState)(!0),n=Object(u.a)(e,2),t=n[0],a=n[1],s=Object(c.useRef)(),o=Object(c.useRef)(),i=Object(c.useCallback)((function(){a(!1),function(e){X.apply(this,arguments)}(o.current)}),[o]);return Object(c.useEffect)((function(){s.current=function(){var e={pc:new RTCPeerConnection(l),dc:null,messageHandlers:{},messageHandlersIndx:"0"};return e.pc.ondatachannel=function(n){e.dc=n.channel,e.dc.onopen=function(){return d(e)},e.dc.onmessage=function(n){return f(e,n)}},e.pc.oniceconnectionstatechange=function(n){return console.log(e.pc.iceConnectionState)},e}(),o.current=function(e){var n=Math.random().toString(36).substr(2,9);return{conn:e,listeners:{},listenerIndex:"0",phase:L.SETUP,userId:n,state:D.PRE_READY,players:[n],readyHashes:{},startNumbers:{},myRandom:null}}(s.current)}),[]),Object(c.useEffect)((function(){var e=j(s.current,(function(e){return function(e,n){console.log("game receiving message!"),console.log(n),"data"===n.type?(N(F.includes(n.method)),console.log(U),U[n.method](e,n)):console.log("ignoring non-data message")}(o.current,e)}));return function(){b(s.current,e)}}),[s,o]),Object(r.jsxs)("div",{className:"App",children:[t&&Object(r.jsx)(Ae,{connRef:s,startGame:i}),!t&&Object(r.jsx)(he,{connRef:s,gameRef:o})]})},Te=function(e){e&&e instanceof Function&&t.e(3).then(t.bind(null,33)).then((function(n){var t=n.getCLS,r=n.getFID,c=n.getFCP,a=n.getLCP,s=n.getTTFB;t(e),r(e),c(e),a(e),s(e)}))};o.a.render(Object(r.jsx)(a.a.StrictMode,{children:Object(r.jsx)(Se,{})}),document.getElementById("root")),Te()}},[[32,1,2]]]);
//# sourceMappingURL=main.8c9676ef.chunk.js.map